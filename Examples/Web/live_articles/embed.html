<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1"> 
        <link rel='stylesheet' href='style_embed.css' type='text/css'>
    </head>

    <body onUnload="stop()" class="page">
        <div class="header">
            <ul>
                <li><img style="position: relative; height: 35px; top: 0px;left: -8px;" src="images/PVW_Logo_Full.png" alt=""/></li>
            </ul>
            <ul class="toolbar" style="position: absolute; right: 10px; top: 2px;display: none;">
                <li id="direct-link"></li>
                <li></li>
                <li><img class="action resetCamera" src="images/resetCamera.png" alt="Previous frame"/></li>
                <li><img class="action stats" src="images/info.png" alt="Toggle statistics"/></li>
                <li><img class="action exit" src="images/exit.png" alt="Exit"/></li>
            </ul>
            <ul id="loading" style="position: absolute; right: 10px; top: 8px;">
                <li><img src="images/loading.gif" alt="Loading"/></li>
            </ul>
        </div>

        <div id="container">
            <div class="viewport">
            </div>
        </div>

        <script src="/js/autobahn.min.js"></script>
        <script src="/js/jquery-1.8.2.min.js"></script>
        <script src="/js/paraview-all.js"></script>

        <script src="js/jquery.jstree.js"></script>

        <script type="text/javascript">
            var pv = {};
            var serviceURL = location.protocol + "//" + location.hostname + ":" + location.port + "/paraview";
            var config = {
                url: serviceURL,
                name: "Live Articles",
                description: "3D visaulization with ParaViewWeb 2.0",
                application: "loader"
            };
            
            // By default start a ParaView on the server

            if(!$('body').hasClass("initialized")) {
                $('body').addClass("initialized");
                $("#loading").hide();
                $("#container").click(function() {
                    if (!pv.connection) {
                        $("#loading").show();
                        paraview.start(config,
                            function(connection){
                                pv.connection = connection;
                                connect();
                            }, function(msg){
                                $("#loading").hide();
                                alert("The remote session did not properly start. Try to use embeded url.");
                                pv.connection = {wampURL: "ws://" + location.hostname + ":" + location.port + "/ws"};
                                connect();
                            });
                    }
                });
                /**
                 * Make the viewport be full screen 
                 */
                $(window).resize(function() {
                    $(".spliter").width(window.innerWidth).height(window.innerHeight - 35);
                    $(".viewport").width(window.innerWidth).height(window.innerHeight - 35);
                    if (pv.viewport) {
                        pv.viewport.render();
                    }
                }).trigger('resize');
            
                // Manage VCR + ResetCamera
                $(".action").click(function(){
                    var me = $(this);
                    if(me.hasClass("toggle")) {
                        me.hide();
                        $("."+me.attr("other")).show();
                    }
                    if(me.hasClass("resetCamera")) {
                        pv.viewport.resetCamera();
                    } else if(me.hasClass("exit")) {
                        stop();
                    } else if (me.hasClass("stats")) {
                        if (me.hasClass("show")) {
                            pv.viewport.showStatistics(null);
                        } else {
                            pv.viewport.showStatistics(pv.stats);
                            pv.stats.reset();
                        }
                        me.toggleClass("show");
                        pv.viewport.render();
                    }
                });
            }
            
            function connect() {
                // Mobiles does not support secured web sockets
                if(paraview.isMobile || location.protocol == "http:") {
                    pv.connection.wampURL = pv.connection.wampURL.replace("wss:","ws:");
                }
                
                paraview.connect(pv.connection,
                startSession, function(code,reason){
                    $("#loading").hide();
                    console.log(reason);
                });
                
                // Update UI to show direct link if available
                if(pv.connection.hasOwnProperty('host') && pv.connection.hasOwnProperty('port')) {
                    $('<a href="http://' + pv.connection.host + ':' + pv.connection.port + '/" target="_blank"><img class="action" src="images/direct.png" alt="Open new tab with direct connection"/></a>').appendTo($("#direct-link"));
                }
            }

            function getParameterByName(name) {
                name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
                var regexS = "[\\?&]" + name + "=([^&#]*)";
                var regex = new RegExp(regexS);
                var results = regex.exec(window.location.search);
                if(results == null)
                    return "";
                else
                    return decodeURIComponent(results[1].replace(/\+/g, " "));
            }
            
            /**
             * Method called when the ParaView session is ready
             */
            function startSession(connection) {
                // Save session for later
                pv.session = connection.session;
                
                // Create viewport
                pv.viewport = paraview.createViewport(connection.session);
                pv.viewport.bind(".viewport");
                pv.stats  = paraview.createViewportStatistics(pv.viewport);
                $("#loading").hide();
                $(".toolbar").show();
               
                var filePath= getParameterByName("data");
                if (filePath !== "") {
                    pv.session.call("pv:openFileFromPath", filePath).then(function(reply){
                        pv.viewport.render();
                        });
                }
            }
            
            /**
             * Method called when the application close
             */
            function stop() {
                if(pv.session) {
                    pv.viewport.unbind();
                    paraview.stop(pv.connection);
                    pv = {};
                }
            }
        </script>
    </body>
</html>
