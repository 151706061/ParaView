# Rules for where jobs can run

###
## Job variables:
##   PV_CI_RUN_MANUALLY
##     Set to "true" if the job should be manually triggered in MRs. These jobs
##     will also be delayed for branch update pipelines
##   PV_CI_MERGED_ONLY
##     Set to "true" to make the job only run for merged pipelines.
##   PV_CI_NIGHTLY_ONLY
##     Set to "true" if the job should only run for nightly pipelines.
####

variables:
    PARAVIEW_CI_PIPELINE_NAME: "ParaView $CI_COMMIT_REF_NAME Pipeline"

# When to even consider running a pipeline
workflow:
    name: "$PARAVIEW_CI_PIPELINE_NAME"
    rules:
        # Run for merge requests.
        - if: '$CI_MERGE_REQUEST_ID'
          when: always
          auto_cancel:
              # Cancel all pipeline jobs if a new commit comes in on the branch/tag.
              on_new_commit: interruptible
          variables:
              PARAVIEW_CI_PIPELINE_NAME: "ParaView MR !$CI_MERGE_REQUEST_IID Pipeline"
        # If this is not a MR, do not run for other projects.
        - if: '$CI_PROJECT_PATH != "paraview/paraview"'
          when: never
        # Run for schedules.
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: always
          auto_cancel:
              # Never cancel scheduled pipelines because of new commits
              on_new_commit: none
          variables:
              PARAVIEW_CI_PIPELINE_NAME: "ParaView $CI_PIPELINE_SCHEDULE_DESCRIPTION Scheduled Pipeline"
        # Run for protected branches.
        - if: '$CI_COMMIT_REF_PROTECTED == "true"'
          when: always
          auto_cancel:
              # Cancel all pipeline jobs if a new commit comes in on the branch.
              on_new_commit: interruptible
          variables:
              PARAVIEW_CI_PIPELINE_NAME: "ParaView Protected Pipeline for $CI_COMMIT_REF_NAME"
        # Run for tags.
        - if: '$CI_COMMIT_TAG'
          when: always
          variables:
              PARAVIEW_CI_PIPELINE_NAME: "ParaView Pipeline for tag $CI_COMMIT_TAG"
        # Skip pipelines in all other cases
        - when: never

# Generic rules block to apply if the pipeline would be run
.rules:
    rules:
        # Merged-only jobs never run on MRs.
        - if: '$CI_MERGE_REQUEST_ID && $PV_CI_MERGED_ONLY == "true"'
          when: never
        # MRs use manual triggers.
        - if: '$CI_MERGE_REQUEST_ID && $PV_CI_RUN_MANUALLY == "true"'
          when: manual
        # Normal jobs run automatically.
        - if: '$CI_MERGE_REQUEST_ID'
          when: on_success
        # Jobs on a tag run right away.
        - if: '$CI_COMMIT_TAG'
          when: on_success
        # Skip schedule jobs without a schedule.
        - if: '$CI_PIPELINE_SOURCE != "schedule" && $PV_CI_NIGHTLY_ONLY == "true"'
          when: never
        # Jobs on a schedule run right away.
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: on_success
        # Manual jobs run delayed (e.g., merges to branches).
        - if: '$PV_CI_RUN_MANUALLY == "true"'
          when: delayed
          start_in: 30 minutes
        # Normal jobs on the project run automatically.
        - when: on_success
