<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="stylesheet" href="../../ext/widgets/jquery-ui/jquery-ui-1.10.0.css" type='text/css'>
        <link rel='stylesheet' href='../../lib/css/paraview.ui.pipeline.css'           type='text/css'>
        <link rel='stylesheet' href='../../lib/css/paraview.ui.toolbar.css'            type='text/css'>
        <link rel='stylesheet' href='../../lib/css/paraview.ui.toolbar.vcr.css'        type='text/css'>
        <link rel='stylesheet' href='../../lib/css/paraview.ui.toolbar.viewport.css'   type='text/css'>
        <link rel='stylesheet' href='main.css' type='text/css'>

        <script src="../../ext/js-core/autobahn.min.js"></script>
        <script src="../../ext/js-core/jquery-1.8.2.min.js"></script>
        <script src="../../ext/js-core/gl-matrix-min.js"></script>

        <script src="../../ext/widgets/jscolor/jscolor.js"></script>
        <script src="../../ext/widgets/jquery-ui/jquery-ui-1.10.0.min.js"></script>

        <script src="../../lib/js/paraview-all.js"></script>
        <script src="../../lib/js/paraview.ui.pipeline.js"></script>
        <script src="../../lib/js/paraview.ui.toolbar.vcr.js"></script>
        <script src="../../lib/js/paraview.ui.toolbar.viewport.js"></script>
    </head>

    <body onbeforeunload="stop()" onunload="stop()" class="page">
        <div class="header toolbar">
            <div class="logo" alt="Toggle pipeline browser visibility"></div>
            <div class="viewport-toolbar"></div>
            <div class="vcr-toolbar"></div>
            <div class="loading"></div>
        </div>
        <div class="splitter">
            <div class="viewport-container">
            </div>
            <div class="control-panel" style="display: none;">
            </div>
        </div>


        <script type="text/javascript">

            // ==== Global variables ===========================================

            var serviceURL = location.protocol + "//" + location.hostname + ":" + location.port + "/paraview",
            config = {
                sessionManagerURL: serviceURL,
                name: "WebVisualizer",
                application: "pipeline"
            },
            pv = { pipeline: null, sources: null, files: null},
            fetchDataQueueSize = 0;

            // ==== Helper method ==============================================

            function fetchServerData(method, dataKey) {
                fetchDataQueueSize++;
                pv.connection.session.call(method).then(function(obj) {
                    pv[dataKey] = obj;
                    fetchDataQueueSize--;
                    onFetchDataDone();
                });
            }

            // ==== Start a new ParaView Session ===============================

            paraview.start( config,
            function(connection){
                pv.connection = connection;
                if(connection.error) {
                    alert(connection.error);
                    window.close();
                } else {
                    connect();
                }
            }, function(msg){
                $("#loading").hide();
                pv.connection = { sessionURL: "ws://" + location.hostname + ":" + location.port + "/ws"};
                connect();
            });

            // ==== Connect to the started ParaView session ====================

            function connect() {
                if(location.protocol == "http:") {
                    pv.connection.sessionURL = pv.connection.sessionURL.replace("wss:","ws:");
                }

                paraview.connect(pv.connection, function(connectionData) {
                    // Create pipeline browser
                    pv.connection = connectionData;

                    // Fetch server state
                    fetchServerData('pv:getPipeline', 'pipeline');
                    fetchServerData('pv:listFilters', 'sources');
                    fetchServerData('pv:listFiles', 'files');

                    // onFetchDataDone() will be called automatically
                }, function(code,reason){
                    $(".loading").hide();
                    console.log(reason);
                });
            }


            // ==== onParaViewReady ============================================

            function onFetchDataDone() {
                if(fetchDataQueueSize != 0) {
                    return; // Not ready yet
                }

                // Update UI

                // - pipeline browser
                $('.control-panel').pipelineBrowser({
                    session: pv.connection.session,
                    pipeline: pv.pipeline,
                    sources: pv.sources,
                    files: pv.files
                }).bind('dataChanged', updateView);

                // - viewport
                $(".viewport-container").empty();
                pv.viewport = paraview.createViewport({session: pv.connection.session});
                pv.viewport.bind(".viewport-container");

                // - vcr toolbar
                $('.vcr-toolbar').vcrToolbar(pv.connection.session).bind('dataChanged', updateView);

                // - viewport toolbar
                $('.viewport-toolbar').viewportToolbar(pv.viewport);

                // - Toggle pipeline visibility
                $('.logo').unbind().bind('click', function(){
                    var panel = $(".control-panel");
                    var viewport = $(".viewport-container");
                    if(panel.is(":visible")) {
                        panel.hide("slide",250, function(){
                            viewport.css("left", 0);
                            if(pv.viewport) {
                                pv.viewport.render();
                            }
                        });
                    } else {
                        panel.show("slide",250, function(){
                            viewport.css("left", 400);
                            if(pv.viewport) {
                                pv.viewport.render();
                            }
                        });
                    }
                }).trigger('click');


                // - loading done...
                $(".loading").hide();
            }

            // ==== onResize ===================================================

            $(window).resize(function() {
                $(".splitter").height(window.innerHeight - 35);
                $(".control-panel").height(window.innerHeight - 35);
            }).trigger('resize');

            // ==== forceRender ================================================

            function updateView() {
                if(pv.viewport) {
                    pv.viewport.invalidateScene();
                }
            }

            /**
             * Method called when the application close
             */
            function stop() {
                if(pv.hasOwnProperty('connection') && pv.connection.session) {
                    pv.viewport.unbind();
                    paraview.stop(pv.connection);
                    pv = {};
                }
            }
        </script>
    </body>
</html>
