<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1">
        <link rel="stylesheet" href="../../css/ext/jquery-ui-1.10.0.css" />
        <link href="../../css/ext/nv.d3.css" rel="stylesheet" />
        <link rel='stylesheet' href='jclv/cvl.css' type='text/css' />
        <link rel='stylesheet' href='style.css' type='text/css' />

        <script src="../../js/ext/autobahn.min.js"></script>
        <script src="../../js/ext/jquery-1.8.3.min.js"></script>
        <script src="../../js/ext/d3.v2.js"></script>
        <script src="../../js/ext/nv.d3.js"></script>
        <script src="../../js/lib/paraview-all.js"></script>

        <script src="../../js/ext/jquery-ui-1.10.0.min.js"></script>

        <script type="text/javascript" src="jclv/cvl.js"></script>
        <script type="text/javascript" src="../../js/lib/paraview.nv.utils.js"></script>
        <script type="text/javascript" src="../../js/lib/paraview.nv.lineChart.js"></script>
        <script type="text/javascript">
        $(function() {
            var viewport$ = $("#viewport");

            //-----------------------------------------------------------------------------
            // 'global' variables.
            var pv = {};

            $(window).resize(function() {
                var height = $(window).height();
                var toolbar = $(".toolbar").height();
                $("#chart").height(height - toolbar).css("top", toolbar + "px");
                $("#viewport").height(height -toolbar).css("top", toolbar + "px");
                if (pv.viewport) {
                    pv.viewport.render();
                }
            }).trigger('resize');

            //-----------------------------------------------------------------------------
            $("#selectdata").button({
                text: false,
                icons : { primary : "select-data" }
            }).next().button({
                text: false,
                icons : { primary : "line-plot" }
            }).next().button({
                text: false,
                icons : { primary : "bar-plot" }
            }).next().button({
                text: false,
                icons : { primary : "toggle-stats" }
            }).next().button({
                text: false,
                icons : { primary : "reset-view" }
            });

            $("#selectdata").click(function(){
              $("#data-selector-dialog").dialog("open");
            });

            $("#togglestats").click(function() {
                var this$ = $(this);
                if (this$.hasClass("on")) {
                    if (pv.stats && pv.viewport) {
                        pv.stats.stop();
                        pv.viewport.showStatistics(null);
                    }
                } else {
                    if (pv.stats && pv.viewport) {
                        pv.stats.start();
                        pv.viewport.showStatistics(pv.stats);
                    }
                }
                this$.toggleClass("on");
            });

            $("#resetview").click(function() {
                if (pv.viewport) {pv.viewport.resetCamera();}
            });

            var showline$ = $("#showline");
            var showbar$ = $("#showbar");

            showline$.click(function() {
              showline$.addClass("on");
              showbar$.removeClass("on");
            }).addClass("on");

            showbar$.click(function() {
              showbar$.addClass("on");
              showline$.removeClass("on");
            })

            // we don't show bar chart for now.
            showbar$.hide();

            function startup() {
                if (viewport$.hasClass("session_started")) {
                    return;
                }
                // We start a new ParaView session everytime the user clicks on
                // the the page.
                if (!pv.connection) {
                    viewport$.addClass("session_started");
                    var serviceURL = location.protocol + "//" + location.hostname +
                                     ":" + location.port + "/paraview";
                    var config = {
                        sessionManagerURL: serviceURL,
                        name: "Data Prober",
                        description: "3D visualization with ParaView/Web",
                        application: "data_prober"
                    };

                    // Start a new ParaView/Web instance.
                    paraview.start(config,
                        function (conn) {
                            setupConnection(conn);
                        },
                        function (err) {
                            //console.log("Connection failed.");

                            var conn = {sessionURL: "ws://" +
                                       location.hostname + ":" +
                                       location.port + "/ws"};
                            setupConnection(conn);
                        }
                    );
                }
            }

            //-----------------------------------------------------------------------------
            // Setup paraview
            function setupConnection(connection) {
                // Mobiles does not support secured web sockets
                if (paraview.isMobile || location.protocol == "http:") {
                    connection.sessionURL = connection.sessionURL.replace("wss:","ws:");
                }

                // connect to the ParaView/Web instance, so we can start
                // visualizing.
                paraview.connect(connection,
                    function(conn) {
                        pv.connection = conn;
                        pv.viewport = paraview.createViewport(conn.session);
                        pv.viewport.bind("#viewport");
                        pv.stats = paraview.createViewportStatistics(pv.viewport);
                        pv.stats.stop();

                        // setup the chart for rendering.
                        pv.chart = $("#chart svg").lineChart({connection : conn});

                    },
                    function(code,reason){
                        pv.connection = null;
                        console.log(reason);
                        cleanup();
                    }
                );
             }

            function cleanup() {
               if (pv.viewport) {
                   pv.viewport.unbind();
               }
               if (pv.connection) {
                   paraview.stop(pv.connection);
               }
               pv = {};
               viewport$.removeClass("session_started");
            }

            $("#data-selector-dialog").dialog({
                height: 460,
                width : 650,
                modal: true,
                autoOpen: false,
                buttons: {
                    "Accept" : function () {
                        $(this).dialog("close");
                    }
                },
                open : function (event, ui) {
                  showAvailableDatasets();
                },
                close : function (event, ui) {
                    var items = $("#t1").cvl.getColumnList().getSelectedItems();
                    var selected_datasets = [];
                    for (var cc=0; cc < items.length; cc++) {
                        var item = items[cc].item;
                        if (item.hasChildren()) { continue; }
                        selected_datasets.push(item.getValue());
                    }
                    console.log(selected_datasets);
                    if (!pv.connection || selected_datasets.length == 0) {
                        return;
                    }
                    var session = pv.connection.session;
                    session.call("pv:loadDatasets",
                      selected_datasets).then(function(){
                          pv.chart.lineChart("updatePlotData");
                          pv.viewport.render();
                      });
                }
            });

            function showAvailableDatasets() {
                if (!pv.connection) {
                    return;
                }

                if (pv.databaseLoaded) {
                  return;
                }

                var session = pv.connection.session;
                session.call("pv:getDatabaseAsHTML").then(function(database_content){
                    pv.databaseLoaded = true;
                    $("#database").html(database_content);
                    $("#t1").html("");
                    var cl = jQuery.fn.jColumnListView({
                        id:               'cl1',
                        width:            600,
                        columnWidth:      200,
                        columnHeight:     200,
                        columnMargin:     8,
                        paramName:        'columnview',
                        columnNum:        4,
                        appendToId:       't1',
                        elementId:        'database',
                        removeAfter:      true,
                        columnMinWidth:   120,
                        columnMaxWidth:   200,
                        childIndicator:   true,
                        leafMode: true,
                        splitterLeftMode: true,
                        singleCheck: true,
                        checkAndClick : true,
                        onItemChecked: function (ci) { console.log(ci); },
                        onItemUnchecked: function (ci) { console.log(ci); }
                    });
                });
            }

            // startup ParaView session.
            startup();
        });
        </script>
    </head>
    <body>
        <div class="toolbar">
          <center>
            <button id="selectdata">Select Data</button>
            <button id="showline">Show Line Plot</button>
            <button id="showbar">Show Bar Plot</button>
            <button id="togglestats">Toggle Statistics</button>
            <button id="resetview">Reset Camera</button>
          </center>
        </div>
        <div id="chart" class="lefthalf">
          <svg></svg>
        </div>
        <div id="viewport" class="righthalf">
        </div>

        <div id="data-selector-dialog" title="Select dataset to Probe">
          <p>
            Select dataset to load for probing. Any previously loaded dataset
            will be unloaded.
          </p>
          <p>
            <div id="t1" style="width: 550px;">
              <p> Connecting ... </p>
            </div>
          </p>
        </div>

        <ul id="database" style="display: none">
        </ul>
    </body>
</html>
